// sprites.js
// ドット絵データ（2次元配列）＋ アトラス生成（描画は render.js）

/* --- palette --- */
const palette = [
  "rgba(0,0,0,0)", // 0: transparent
  "#000000", // 1
  "#808080", // 2
  "#C0C0C0", // 3
  "#FFFFFF", // 4
  "#FF0000", // 5
  "#800000", // 6
  "#FFFF00", // 7
  "#808000", // 8
  "#00FF00", // 9
  "#008000", // 10
  "#00FFFF", // 11
  "#008080", // 12
  "#0000FF", // 13
  "#000080", // 14
  "#FF00FF", // 15
  "#800080", // 16
];

/* ===== Player (plain) 8x8 ===== */
const dotPlayerPlainRight = [
  [0, 13, 13, 13, 0, 0, 0, 0],
  [13, 13, 13, 13, 13, 0, 0, 0],
  [13, 7, 1, 7, 1, 0, 0, 0],
  [13, 7, 7, 7, 7, 0, 0, 0],
  [13, 13, 13, 13, 0, 0, 0, 0],
  [13, 13, 3, 13, 3, 0, 0, 0],
  [3, 3, 0, 3, 0, 0, 0, 0],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const dotPlayerPlainUp = [
  [0, 0, 13, 13, 13, 0, 0, 0],
  [0, 13, 13, 13, 13, 13, 0, 0],
  [0, 13, 13, 13, 7, 1, 0, 0],
  [0, 13, 13, 13, 7, 7, 0, 0],
  [0, 13, 13, 13, 13, 13, 3, 0],
  [0, 3, 13, 13, 13, 13, 0, 0],
  [0, 0, 3, 0, 3, 3, 0, 0],
  [0, 3, 3, 0, 0, 0, 0, 0],
];
const dotPlayerPlainLeft = [
  [0, 0, 0, 0, 13, 13, 13, 0],
  [0, 0, 0, 13, 13, 13, 13, 13],
  [0, 0, 0, 1, 7, 1, 7, 13],
  [0, 0, 0, 7, 7, 7, 7, 13],
  [0, 0, 0, 0, 13, 13, 13, 13],
  [0, 0, 0, 3, 13, 3, 13, 13],
  [0, 0, 0, 0, 3, 0, 3, 3],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const dotPlayerPlainDown = [
  [0, 0, 0, 13, 13, 13, 0, 0],
  [0, 0, 13, 13, 13, 13, 13, 0],
  [0, 0, 7, 1, 7, 1, 7, 0],
  [0, 0, 7, 7, 7, 7, 7, 0],
  [0, 3, 13, 13, 13, 13, 13, 0],
  [0, 0, 13, 13, 13, 13, 3, 0],
  [0, 0, 3, 3, 0, 3, 0, 0],
  [0, 0, 0, 0, 0, 3, 3, 0],
];

/* ===== Player (sword) 8x8 ===== */
const dotPlayerSwordRight = [
  [0, 13, 13, 13, 0, 0, 0, 0],
  [13, 13, 13, 13, 13, 0, 0, 0],
  [13, 7, 1, 7, 1, 0, 0, 3],
  [13, 7, 7, 7, 7, 0, 3, 0],
  [13, 13, 13, 13, 0, 3, 0, 0],
  [13, 13, 3, 13, 3, 0, 0, 0],
  [3, 3, 0, 3, 0, 0, 0, 0],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const dotPlayerSwordUp = [
  [0, 0, 13, 13, 13, 0, 0, 0],
  [0, 13, 13, 13, 13, 13, 0, 3],
  [0, 13, 13, 13, 7, 1, 0, 3],
  [0, 13, 13, 13, 7, 7, 0, 3],
  [0, 13, 13, 13, 13, 13, 3, 0],
  [0, 3, 13, 13, 13, 13, 0, 0],
  [0, 0, 3, 0, 3, 3, 0, 0],
  [0, 3, 3, 0, 0, 0, 0, 0],
];
const dotPlayerSwordLeft = [
  [0, 0, 0, 0, 13, 13, 13, 0],
  [0, 0, 0, 13, 13, 13, 13, 13],
  [3, 0, 0, 1, 7, 1, 7, 13],
  [0, 3, 0, 7, 7, 7, 7, 13],
  [0, 0, 3, 0, 13, 13, 13, 13],
  [0, 0, 0, 3, 13, 3, 13, 13],
  [0, 0, 0, 0, 3, 0, 3, 3],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const dotPlayerSwordDown = [
  [0, 0, 0, 13, 13, 13, 0, 0],
  [3, 0, 13, 13, 13, 13, 13, 0],
  [3, 0, 7, 1, 7, 1, 7, 0],
  [3, 0, 7, 7, 7, 7, 7, 0],
  [0, 3, 13, 13, 13, 13, 13, 0],
  [0, 0, 13, 13, 13, 13, 3, 0],
  [0, 0, 3, 3, 0, 3, 0, 0],
  [0, 0, 0, 0, 0, 3, 3, 0],
];

/* ===== Tiles 8x8 ===== */
const dotWall = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [6, 6, 6, 1, 6, 6, 6, 1],
  [1, 1, 1, 1, 1, 1, 1, 1],
  [6, 1, 6, 6, 1, 6, 6, 6],
  [1, 1, 1, 1, 1, 1, 1, 1],
  [6, 6, 6, 1, 6, 6, 6, 1],
];
const dotHome = [
  [0, 0, 6, 6, 6, 6, 6, 0],
  [0, 6, 6, 6, 6, 6, 6, 6],
  [0, 6, 6, 6, 6, 6, 6, 6],
  [0, 4, 4, 4, 4, 4, 4, 4],
  [0, 4, 4, 6, 6, 6, 4, 4],
  [0, 4, 4, 6, 2, 6, 4, 4],
  [0, 4, 4, 6, 6, 6, 4, 4],
  [0, 2, 2, 6, 6, 6, 2, 2],
];
const dotDoor = [
  [0, 0, 0, 3, 3, 3, 0, 0],
  [0, 0, 3, 6, 6, 6, 3, 0],
  [0, 3, 6, 6, 6, 6, 6, 3],
  [0, 3, 3, 3, 3, 3, 3, 3],
  [0, 3, 6, 6, 6, 6, 6, 3],
  [0, 3, 6, 6, 6, 1, 6, 3],
  [0, 3, 3, 3, 3, 3, 3, 3],
  [0, 3, 6, 6, 6, 6, 6, 3],
];
const dotFire = [
  [0, 0, 5, 0, 0, 5, 0, 0],
  [0, 5, 0, 0, 5, 0, 0, 5],
  [0, 0, 0, 5, 0, 5, 0, 0],
  [0, 0, 5, 7, 5, 0, 0, 0],
  [0, 5, 7, 7, 7, 5, 0, 0],
  [0, 5, 7, 7, 7, 5, 0, 0],
  [0, 0, 5, 7, 7, 5, 0, 0],
  [0, 0, 0, 5, 5, 0, 0, 0],
];
const dotGrave = [
  [0, 0, 2, 3, 3, 3, 2, 0],
  [0, 2, 3, 3, 2, 3, 3, 2],
  [0, 2, 3, 2, 2, 2, 3, 2],
  [0, 2, 3, 3, 2, 3, 3, 2],
  [0, 2, 3, 3, 2, 3, 3, 2],
  [0, 2, 3, 3, 3, 3, 3, 2],
  [0, 2, 2, 3, 3, 3, 2, 2],
  [0, 2, 2, 2, 2, 2, 2, 2],
];

/* ===== Items (8x8) ===== */
const itemCoin = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 4, 7, 0, 0, 0],
  [0, 0, 4, 7, 7, 7, 0, 0],
  [0, 0, 4, 7, 7, 8, 0, 0],
  [0, 0, 4, 7, 7, 8, 0, 0],
  [0, 0, 7, 7, 7, 8, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const itemGem = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 4, 4, 11, 11, 0, 0],
  [0, 4, 4, 11, 11, 11, 11, 0],
  [0, 4, 11, 11, 11, 11, 11, 0],
  [0, 11, 11, 11, 11, 11, 12, 0],
  [0, 0, 11, 11, 11, 12, 0, 0],
  [0, 0, 0, 11, 12, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const itemSword = [
  [0, 0, 0, 0, 0, 0, 0, 3],
  [0, 0, 0, 0, 0, 0, 3, 0],
  [0, 0, 0, 0, 0, 3, 0, 0],
  [0, 6, 0, 0, 3, 0, 0, 0],
  [0, 0, 6, 3, 0, 0, 0, 0],
  [0, 0, 6, 6, 0, 0, 0, 0],
  [0, 6, 0, 0, 6, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const itemRing = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 11, 11, 0, 0, 0],
  [0, 0, 0, 11, 11, 0, 0, 0],
  [0, 0, 0, 3, 3, 0, 0, 0],
  [0, 0, 3, 0, 0, 3, 0, 0],
  [0, 3, 0, 0, 0, 0, 3, 0],
  [0, 0, 3, 0, 0, 3, 0, 0],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const itemCross = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 7, 7, 7, 7, 7, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 0, 0, 7, 8, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const itemKey = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 7, 0],
  [0, 0, 0, 0, 0, 7, 0, 7],
  [7, 7, 7, 7, 7, 7, 0, 7],
  [7, 0, 7, 0, 0, 7, 0, 7],
  [7, 0, 0, 0, 0, 0, 7, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const itemShield = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 3, 3, 2, 2, 2, 0],
  [0, 3, 6, 6, 6, 6, 6, 2],
  [0, 3, 3, 3, 2, 2, 2, 2],
  [0, 3, 6, 6, 6, 6, 6, 2],
  [0, 3, 6, 6, 6, 6, 6, 2],
  [0, 0, 3, 6, 6, 6, 2, 0],
  [0, 0, 0, 3, 2, 2, 0, 0],
];
const itemCrown = [
  [0, 0, 0, 0, 7, 0, 0, 0],
  [0, 7, 0, 5, 7, 5, 0, 7],
  [0, 7, 5, 5, 7, 5, 5, 7],
  [0, 7, 5, 7, 7, 7, 5, 7],
  [0, 7, 7, 7, 11, 7, 7, 7],
  [0, 5, 7, 11, 11, 11, 7, 5],
  [0, 7, 7, 7, 11, 7, 7, 7],
  [0, 5, 5, 5, 5, 5, 5, 5],
];

/* ===== Enemies (8x8) ===== */
const enemyBat = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 13, 0, 13, 0, 0],
  [0, 13, 13, 0, 0, 0, 13, 13],
  [0, 13, 13, 13, 3, 13, 13, 13],
  [0, 13, 0, 0, 3, 0, 0, 13],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const enemySlime = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 9, 9, 9, 0, 0],
  [0, 0, 9, 9, 9, 9, 9, 0],
  [0, 9, 1, 9, 1, 9, 9, 9],
  [0, 9, 9, 9, 9, 9, 9, 9],
  [0, 0, 0, 0, 0, 0, 0, 0],
];
const enemyGoblin = [
  [0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 10, 10, 0, 10],
  [0, 0, 0, 10, 10, 10, 10, 10],
  [3, 0, 10, 10, 1, 10, 10, 0],
  [0, 3, 0, 10, 10, 10, 0, 0],
  [0, 0, 10, 6, 6, 6, 6, 0],
  [0, 0, 0, 0, 6, 6, 0, 10],
  [0, 0, 0, 10, 10, 0, 10, 0],
];
const enemyWizard = [
  [0, 0, 0, 0, 0, 15, 15, 0],
  [0, 0, 0, 0, 15, 15, 0, 0],
  [0, 0, 0, 15, 15, 15, 15, 0],
  [6, 0, 0, 7, 1, 7, 15, 0],
  [0, 6, 0, 1, 1, 1, 15, 15],
  [0, 0, 15, 15, 1, 15, 15, 0],
  [0, 0, 0, 15, 15, 15, 15, 0],
  [0, 0, 0, 15, 15, 15, 15, 15],
];
const enemySkull = [
  [0, 0, 0, 4, 4, 4, 0, 0],
  [0, 0, 0, 4, 4, 4, 0, 0],
  [4, 0, 0, 1, 4, 1, 0, 0],
  [0, 4, 0, 4, 4, 4, 6, 6],
  [0, 0, 4, 3, 3, 3, 6, 6],
  [0, 0, 0, 0, 3, 0, 0, 0],
  [0, 0, 0, 3, 0, 3, 3, 0],
  [0, 0, 3, 3, 0, 0, 0, 0],
];
const enemyKnight = [
  [0, 0, 0, 0, 15, 15, 15, 0],
  [0, 0, 0, 15, 15, 15, 15, 15],
  [3, 0, 0, 1, 1, 1, 1, 15],
  [0, 3, 0, 15, 1, 15, 15, 15],
  [0, 0, 3, 0, 16, 16, 16, 16],
  [0, 0, 0, 3, 16, 3, 16, 16],
  [0, 0, 0, 0, 3, 0, 3, 3],
  [0, 0, 0, 3, 3, 0, 0, 0],
];
const enemyLizardman = [
  [0, 0, 0, 0, 5, 10, 5, 0],
  [0, 0, 0, 10, 10, 10, 10, 10],
  [8, 0, 0, 0, 0, 0, 10, 10],
  [0, 8, 0, 10, 10, 10, 10, 10],
  [0, 0, 8, 0, 8, 8, 8, 8],
  [0, 0, 0, 10, 8, 10, 8, 8],
  [0, 0, 0, 0, 10, 0, 10, 10],
  [0, 0, 0, 10, 10, 0, 0, 0],
];
const enemyOgre = [
  [0, 0, 13, 0, 0, 13, 0, 0],
  [0, 0, 6, 11, 6, 11, 0, 0],
  [0, 13, 11, 11, 11, 11, 13, 13],
  [0, 13, 11, 11, 11, 11, 0, 13],
  [0, 6, 6, 6, 6, 6, 11, 11],
  [0, 4, 4, 13, 13, 13, 11, 11],
  [4, 4, 4, 4, 13, 13, 0, 0],
  [0, 0, 11, 11, 0, 11, 11, 0],
];
const enemyDragon = [
  [0, 5, 10, 5, 10, 0, 0, 0],
  [10, 10, 10, 10, 10, 0, 10, 0],
  [0, 0, 0, 0, 10, 0, 0, 10],
  [10, 10, 10, 10, 10, 0, 0, 10],
  [0, 0, 8, 10, 10, 8, 10, 0],
  [0, 8, 8, 8, 8, 8, 8, 0],
  [0, 10, 8, 8, 8, 8, 10, 0],
  [10, 10, 0, 0, 0, 0, 10, 10],
];

/* ===== draw utility ===== */
function drawDotPattern(g, dot, startX, startY, dotSize = 5) {
  g.noStroke();
  for (let y = 0; y < dot.length; y++) {
    for (let x = 0; x < dot[y].length; x++) {
      const c = dot[y][x];
      if (c !== 0) {
        g.fill(palette[c]);
        g.rect(startX + x * dotSize, startY + y * dotSize, dotSize, dotSize);
      }
    }
  }
}

/**
 * スプライトアトラス生成
 * @param {Object} opts { dotSize=5, frameSize=40 }
 * @returns {{image:p5.Image, rects:Object<string,{x,y,w,h}>}}
 */
export function buildSpriteAtlas(opts = {}) {
  const dotSize = opts.dotSize ?? 5;
  const frame = opts.frameSize ?? 40;

  const entries = [
    // player plain
    ["playerPlainRight", dotPlayerPlainRight],
    ["playerPlainUp", dotPlayerPlainUp],
    ["playerPlainLeft", dotPlayerPlainLeft],
    ["playerPlainDown", dotPlayerPlainDown],
    // player sword
    ["playerSwordRight", dotPlayerSwordRight],
    ["playerSwordUp", dotPlayerSwordUp],
    ["playerSwordLeft", dotPlayerSwordLeft],
    ["playerSwordDown", dotPlayerSwordDown],
    // tiles
    ["wall", dotWall],
    ["home", dotHome],
    ["door", dotDoor],
    ["fire", dotFire],
    ["grave", dotGrave],
    // items
    ["itemCoin", itemCoin],
    ["itemGem", itemGem],
    ["itemSword", itemSword],
    ["itemRing", itemRing],
    ["itemCross", itemCross],
    ["itemKey", itemKey],
    ["itemShield", itemShield],
    ["itemCrown", itemCrown],
    // enemies
    ["enemyBat", enemyBat],
    ["enemySlime", enemySlime],
    ["enemyGoblin", enemyGoblin],
    ["enemyWizard", enemyWizard],
    ["enemySkull", enemySkull],
    ["enemyKnight", enemyKnight],
    ["enemyLizardman", enemyLizardman],
    ["enemyOgre", enemyOgre],
    ["enemyDragon", enemyDragon],
  ];

  const g = createGraphics(entries.length * frame, frame);
  g.pixelDensity(1);
  g.noSmooth();
  g.clear();

  const rects = {};
  entries.forEach(([key, data], i) => {
    drawDotPattern(g, data, i * frame, 0, dotSize);
    rects[key] = { x: i * frame, y: 0, w: frame, h: frame };
  });

  return { image: g.get(), rects };
}
